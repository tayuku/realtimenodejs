Based on socket.io 's example